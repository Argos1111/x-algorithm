# X For You フィードアルゴリズム

このリポジトリには、Xの「For You」フィードを駆動するコアレコメンデーションシステムが含まれています。フォローしているアカウントからのネットワーク内コンテンツと、MLベースの検索によって発見されたネットワーク外コンテンツを組み合わせ、Grokベースのトランスフォーマーモデルを使用してすべてをランキングします。

> **注意:** トランスフォーマーの実装は、xAIによる[Grok-1オープンソースリリース](https://github.com/xai-org/grok-1)から移植され、レコメンデーションシステムのユースケースに適応させたものです。

## 目次

- [概要](#概要)
- [システムアーキテクチャ](#システムアーキテクチャ)
- [コンポーネント](#コンポーネント)
  - [Home Mixer](#home-mixer)
  - [Thunder](#thunder)
  - [Phoenix](#phoenix)
  - [Candidate Pipeline](#candidate-pipeline)
- [動作原理](#動作原理)
  - [パイプラインステージ](#パイプラインステージ)
  - [スコアリングとランキング](#スコアリングとランキング)
  - [フィルタリング](#フィルタリング)
- [主要な設計決定](#主要な設計決定)
- [ライセンス](#ライセンス)

---

## 概要

For Youフィードアルゴリズムは、2つのソースから投稿を取得、ランキング、フィルタリングします：

1. **ネットワーク内（Thunder）**: フォローしているアカウントからの投稿
2. **ネットワーク外（Phoenix Retrieval）**: グローバルコーパスから発見された投稿

両方のソースは統合され、**Phoenix**（Grokベースのトランスフォーマーモデル）を使用して一緒にランキングされます。このモデルは各投稿のエンゲージメント確率を予測します。最終スコアは、これらの予測されたエンゲージメントの重み付き組み合わせです。

私たちは、システムから手作業で設計された特徴量とほとんどのヒューリスティックをすべて排除しました。Grokベースのトランスフォーマーが、あなたのエンゲージメント履歴（いいね、返信、共有など）を理解し、それを使用してどのコンテンツがあなたに関連しているかを判断することで、すべての重労働を行います。

---

## システムアーキテクチャ

```
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                 For You フィードリクエスト                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      ホームミキサー                                          │
│                                  (オーケストレーション層)                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                               クエリハイドレーション                                  │   │
│   │  ┌──────────────────────────┐    ┌──────────────────────────────────────────────┐   │   │
│   │  │ ユーザーアクション         │    │ ユーザー特徴                                  │   │   │
│   │  │ シーケンス                │    │ (フォローリスト、設定など)                     │   │   │
│   │  │ (エンゲージメント履歴)     │    │                                              │   │   │
│   │  └──────────────────────────┘    └──────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                    候補ソース                                        │   │
│   │         ┌─────────────────────────────┐    ┌────────────────────────────────┐       │   │
│   │         │        THUNDER              │    │     PHOENIX 検索               │       │   │
│   │         │   (ネットワーク内投稿)        │    │  (ネットワーク外投稿)           │       │   │
│   │         │                             │    │                                │       │   │
│   │         │  フォローアカウントの         │    │  MLベース類似性検索             │       │   │
│   │         │  投稿                       │    │  グローバルコーパス全体          │       │   │
│   │         └─────────────────────────────┘    └────────────────────────────────┘       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                  ハイドレーション                                    │   │
│   │  追加データ取得: コア投稿メタデータ、著者情報、メディアエンティティなど                   │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                  フィルタリング                                      │   │
│   │  除去: 重複、古い投稿、自己投稿、ブロック著者、ミュートキーワードなど                     │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                   スコアリング                                       │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  Phoenix スコアラー       │    Grokベーストランスフォーマー予測:                    │   │
│   │  │  (ML予測)                │    P(like), P(reply), P(repost), P(click)...          │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  重み付きスコアラー        │    重み付きスコア = Σ (重み × P(アクション))            │   │
│   │  │  (予測の統合)             │                                                       │   │
│   │  └──────────────────────────┘                                                       │   │
│   │               │                                                                     │   │
│   │               ▼                                                                     │   │
│   │  ┌──────────────────────────┐                                                       │   │
│   │  │  著者多様性               │    繰り返し著者スコアを減衰                             │   │
│   │  │  スコアラー               │    フィード多様性を確保                                 │   │
│   │  └──────────────────────────┘                                                       │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                       選択                                          │   │
│   │                    最終スコアでソート、上位K候補を選択                                 │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                              │                                              │
│                                              ▼                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                            フィルタリング (選択後)                                    │   │
│   │              可視性フィルタリング (削除済/スパム/暴力/グロテスクなど)                    │   │
│   └─────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                             │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
                                               │
                                               ▼
┌─────────────────────────────────────────────────────────────────────────────────────────────┐
│                                ランク付きフィードレスポンス                                    │
└─────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント

### Home Mixer

**場所:** [`home-mixer/`](home-mixer/)

For Youフィードを組み立てるオーケストレーション層です。以下のステージを持つ`CandidatePipeline`フレームワークを活用します：

| ステージ | 説明 |
|-------|-------------|
| Query Hydrators | ユーザーコンテキスト（エンゲージメント履歴、フォローリスト）を取得 |
| Sources | ThunderとPhoenixから候補を取得 |
| Hydrators | 追加データで候補を充実化 |
| Filters | 不適格な候補を除去 |
| Scorers | エンゲージメントを予測し、最終スコアを計算 |
| Selector | スコアでソートし、上位K件を選択 |
| Post-Selection Filters | 最終的な可視性と重複チェック |
| Side Effects | 将来の使用のためにリクエスト情報をキャッシュ |

サーバーは、指定されたユーザーのランキングされた投稿を返すgRPCエンドポイント（`ScoredPostsService`）を公開します。

---

### Thunder

**場所:** [`thunder/`](thunder/)

すべてのユーザーからの最近の投稿を追跡するインメモリ投稿ストアとリアルタイム取り込みパイプラインです。以下を行います：

- Kafkaから投稿の作成/削除イベントを消費
- オリジナル投稿、返信/リポスト、動画投稿のユーザー別ストアを維持
- リクエストユーザーがフォローしているアカウントからの「ネットワーク内」投稿候補を提供
- 保持期間を超えた投稿を自動的にトリミング

Thunderは、外部データベースにアクセスすることなく、ネットワーク内コンテンツをミリ秒以下で検索できるようにします。

---

### Phoenix

**場所:** [`phoenix/`](phoenix/)

2つの主要な機能を持つMLコンポーネント：

#### 1. 検索（Two-Towerモデル）
関連するネットワーク外投稿を見つけます：
- **User Tower**: ユーザー特徴とエンゲージメント履歴を埋め込みにエンコード
- **Candidate Tower**: すべての投稿を埋め込みにエンコード
- **類似性検索**: ドット積類似性を介してトップK件の投稿を取得

#### 2. ランキング（候補分離を持つトランスフォーマー）
各候補のエンゲージメント確率を予測します：
- ユーザーコンテキスト（エンゲージメント履歴）と候補投稿を入力として受け取る
- 候補が互いにアテンションできないように特別なアテンションマスキングを使用
- 各アクションタイプ（いいね、返信、リポスト、クリックなど）の確率を出力

詳細なアーキテクチャドキュメントについては、[`phoenix/README.md`](phoenix/README.md)を参照してください。

---

### Candidate Pipeline

**場所:** [`candidate-pipeline/`](candidate-pipeline/)

レコメンデーションパイプラインを構築するための再利用可能なフレームワークです。以下のトレイトを定義します：

| トレイト | 目的 |
|-------|---------|
| `Source` | データソースから候補を取得 |
| `Hydrator` | 追加の特徴で候補を充実化 |
| `Filter` | 表示すべきでない候補を除去 |
| `Scorer` | ランキングのためのスコアを計算 |
| `Selector` | 上位候補をソートして選択 |
| `SideEffect` | 非同期サイドエフェクトを実行（キャッシング、ロギング） |

フレームワークは、可能な場合にソースとハイドレーターを並列実行し、設定可能なエラー処理とロギングを備えています。

---

## 動作原理

### パイプラインステージ

1. **Query Hydration**: ユーザーの最近のエンゲージメント履歴とメタデータ（例：フォローリスト）を取得

2. **Candidate Sourcing**: 以下から候補を取得：
   - **Thunder**: フォローしているアカウントからの最近の投稿（ネットワーク内）
   - **Phoenix Retrieval**: グローバルコーパスからMLで発見された投稿（ネットワーク外）

3. **Candidate Hydration**: 候補を以下で充実化：
   - コア投稿データ（テキスト、メディアなど）
   - 著者情報（ユーザー名、認証ステータス）
   - 動画の長さ（動画投稿の場合）
   - サブスクリプションステータス

4. **Pre-Scoring Filters**: 以下の投稿を除去：
   - 重複
   - 古すぎる投稿
   - 閲覧者自身からの投稿
   - ブロック/ミュートされたアカウントからの投稿
   - ミュートされたキーワードを含む投稿
   - 以前に見た、または最近提供された投稿
   - 不適格なサブスクリプションコンテンツ

5. **Scoring**: 複数のスコアラーを順次適用：
   - **Phoenix Scorer**: PhoenixトランスフォーマーモデルからのML予測を取得
   - **Weighted Scorer**: 予測を最終的な関連性スコアに統合
   - **Author Diversity Scorer**: 多様性のために繰り返し著者のスコアを減衰
   - **OON Scorer**: ネットワーク外コンテンツのスコアを調整

6. **Selection**: スコアでソートし、上位K件の候補を選択

7. **Post-Selection Processing**: 提供される投稿候補の最終検証

---

### スコアリングとランキング

Phoenix Grokベースのトランスフォーマーモデルは、複数のエンゲージメントタイプの確率を予測します：

```
Predictions:
├── P(favorite)
├── P(reply)
├── P(repost)
├── P(quote)
├── P(click)
├── P(profile_click)
├── P(video_view)
├── P(photo_expand)
├── P(share)
├── P(dwell)
├── P(follow_author)
├── P(not_interested)
├── P(block_author)
├── P(mute_author)
└── P(report)
```

**Weighted Scorer**は、これらを最終スコアに統合します：

```
Final Score = Σ (weight_i × P(action_i))
```

ポジティブアクション（いいね、リポスト、共有）にはポジティブな重みがあります。ネガティブアクション（ブロック、ミュート、報告）にはネガティブな重みがあり、ユーザーが嫌う可能性が高いコンテンツを押し下げます。

---

### フィルタリング

フィルターは2つのステージで実行されます：

**Pre-Scoring Filters:**
| フィルター | 目的 |
|--------|---------|
| `DropDuplicatesFilter` | 重複する投稿IDを除去 |
| `CoreDataHydrationFilter` | コアメタデータのハイドレーションに失敗した投稿を除去 |
| `AgeFilter` | しきい値より古い投稿を除去 |
| `SelfpostFilter` | ユーザー自身の投稿を除去 |
| `RepostDeduplicationFilter` | 同じコンテンツのリポストを重複排除 |
| `IneligibleSubscriptionFilter` | ユーザーがアクセスできない有料コンテンツを除去 |
| `PreviouslySeenPostsFilter` | ユーザーがすでに見た投稿を除去 |
| `PreviouslyServedPostsFilter` | セッション内ですでに提供された投稿を除去 |
| `MutedKeywordFilter` | ユーザーのミュートされたキーワードを含む投稿を除去 |
| `AuthorSocialgraphFilter` | ブロック/ミュートされた著者からの投稿を除去 |

**Post-Selection Filters:**
| フィルター | 目的 |
|--------|---------|
| `VFFilter` | 削除済み/スパム/暴力/グロテスクなどの投稿を除去 |
| `DedupConversationFilter` | 同じ会話スレッドの複数のブランチを重複排除 |

---

## 主要な設計決定

### 1. 手作業で設計された特徴量なし
システムは、ユーザーエンゲージメントシーケンスから関連性を学習するために、Grokベースのトランスフォーマーに完全に依存しています。コンテンツの関連性のための手動特徴エンジニアリングはありません。これにより、データパイプラインとサービングインフラストラクチャの複雑さが大幅に削減されます。

### 2. ランキングにおける候補分離
トランスフォーマー推論中、候補は互いにアテンションできず、ユーザーコンテキストにのみアテンションします。これにより、投稿のスコアがバッチ内の他の投稿に依存しないことが保証され、スコアが一貫性があり、キャッシュ可能になります。

### 3. ハッシュベースの埋め込み
検索とランキングの両方で、埋め込みルックアップに複数のハッシュ関数を使用します

### 4. マルチアクション予測
単一の「関連性」スコアを予測するのではなく、モデルは多くのアクションの確率を予測します。

### 5. 組み立て可能なパイプラインアーキテクチャ
`candidate-pipeline`クレートは、以下を備えたレコメンデーションパイプラインを構築するための柔軟なフレームワークを提供します：
- パイプライン実行と監視をビジネスロジックから分離
- 独立したステージの並列実行とグレースフルなエラー処理
- 新しいソース、ハイドレーション、フィルター、スコアラーの追加が容易

---

## ライセンス

このプロジェクトは、Apache License 2.0の下でライセンスされています。詳細については、[LICENSE](LICENSE)を参照してください。
